{% extends 'base.html' %}
{% load static %}
{% block title %}Profile · AI Japanese Feedback{% endblock %}
{% block content %}
<style>
  /* Inline preview panel within the container */
  .avatar-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 9999; display: none; align-items: center; justify-content: center; padding: 2rem; }
  .avatar-modal.open { display: flex; }
  .avatar-modal-content { position: relative; max-width: 400px; max-height: 400px; background: var(--bg-primary); border-radius: 16px; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.25); }
  .avatar-modal img { display: block; width: 100%; height: auto; max-height: 400px; object-fit: contain; }
  .avatar-modal-close { position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border-radius: 50%; background: rgba(0,0,0,0.6); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 300; }
  .avatar-modal-close:hover { background: rgba(0,0,0,0.8); }
  .avatar-edit-btn:hover { background: var(--bg-secondary); transform: scale(1.05); transition: all 0.2s ease; }
  [data-theme="dark"] .avatar-edit-btn img { filter: invert(1); }
</style>

<h1 style="font-size:1.25rem; margin-bottom:1rem;">Profile</h1>

<form method="post" enctype="multipart/form-data" novalidate style="display:grid; gap:1rem; max-width:720px;">
  {% csrf_token %}

  <div style="display:flex; gap:1.25rem; align-items:flex-start;">
    <div style="min-width:120px; text-align:center;">
      <div class="avatar-container" style="position:relative; width:96px; height:96px; margin:0 auto;">
        <div id="avatarClickTarget" style="width:100%;height:100%;border-radius:50%;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.12);background:linear-gradient(135deg, var(--brand), var(--brand-2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:1.6rem; cursor: pointer;" title="Click to view full size" role="button" tabindex="0">
          {% if profile.avatar %}
            <img id="avatarPreview" src="{{ profile.avatar.url }}" alt="avatar" style="width:100%;height:100%;object-fit:cover;display:block;" />
          {% else %}
            <span id="avatarInitial">{{ user.username|slice:":1"|upper }}</span>
            <img id="avatarPreview" src="" alt="avatar" style="width:100%;height:100%;object-fit:cover;display:none;" />
          {% endif %}
        </div>
        <label for="id_avatar" class="avatar-edit-btn" style="position:absolute; bottom:-2px; right:-2px; width:28px; height:28px; border-radius:50%; background:var(--bg-primary); border:2px solid var(--border-color); display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.15);" title="Edit profile picture">
          <img src="{% static 'core/edit-icon.svg' %}" alt="Edit" width="14" height="14">
        </label>
      </div>
      <div style="margin-top:.8rem; text-align:center;">
        <label style="display:inline-flex; align-items:center; gap:.4rem; font-size:.85rem; color:var(--text-muted);">
          {{ avatar_form.remove_avatar }} <span>Remove avatar</span>
        </label>
      </div>
    </div>
    <div style="flex:1; display:grid; gap:.75rem;">
      {% if form.non_field_errors %}
        <div style="padding:.6rem .8rem; border-radius:8px; background: rgba(239,68,68,.12); color:#b91c1c; border:1px solid rgba(239,68,68,.25);">{{ form.non_field_errors }}</div>
      {% endif %}

      <div>
        <label style="display:block; font-weight:600; margin-bottom:.25rem;">Username</label>
        {{ form.username }}
        {{ form.username.errors }}
      </div>
      <div style="display:flex; gap:.75rem;">
        <div style="flex:1;">
          <label style="display:block; font-weight:600; margin-bottom:.25rem;">First name</label>
          {{ form.first_name }}
          {{ form.first_name.errors }}
        </div>
        <div style="flex:1;">
          <label style="display:block; font-weight:600; margin-bottom:.25rem;">Last name</label>
          {{ form.last_name }}
          {{ form.last_name.errors }}
        </div>
      </div>
      <div>
        <label style="display:block; font-weight:600; margin-bottom:.25rem;">Email</label>
        {{ form.email }}
        {{ form.email.errors }}
      </div>
    </div>
  </div>

  <input type="file" id="id_avatar" name="avatar" accept="image/*" style="display:none;" />
  {% if avatar_form.non_field_errors %}
    <div style="color:#b91c1c;">{{ avatar_form.non_field_errors }}</div>
  {% endif %}
  {% for f in avatar_form %}
    {% if f.errors %}<div style="color:#b91c1c;">{{ f.errors }}</div>{% endif %}
  {% endfor %}

  <div style="display:flex; gap:.5rem; align-items:center; margin-top:.25rem;">
    <button class="btn btn-primary" type="submit">Save Changes</button>
    <a class="btn btn-secondary" href="{% url 'password_update' %}">Change Password</a>
  </div>
</form>
<div id="avatarModal" class="avatar-modal" aria-hidden="true">
  <div class="avatar-modal-content">
    <button type="button" class="avatar-modal-close" id="avatarPreviewClose">×</button>
    <img id="avatarFull" src="" alt="Profile picture">
  </div>
</div>
<script>
  (function(){
    const fileInput = document.getElementById('id_avatar');
    const preview = document.getElementById('avatarPreview');
    const initial = document.getElementById('avatarInitial');
    const clickTarget = document.getElementById('avatarClickTarget');
    const panel = document.getElementById('avatarModal');
    const full = document.getElementById('avatarFull');
    let currentUrl = preview && preview.src ? preview.src : '';
    if (!fileInput) return;
    let lastUrl = null;
    fileInput.addEventListener('change', function(){
      const f = this.files && this.files[0];
      if (!f) return;
      if (lastUrl) URL.revokeObjectURL(lastUrl);
      const url = URL.createObjectURL(f);
      lastUrl = url;
      currentUrl = url;
      if (initial) initial.style.display = 'none';
      if (preview){ preview.src = url; preview.style.display = 'block'; }
      // Also update navbar avatar if present
      const navAvatar = document.querySelector('.profile-wrap .avatar');
      if (navAvatar){
        let navImg = navAvatar.querySelector('img');
        if (!navImg){
          navImg = document.createElement('img');
          navImg.alt = 'avatar';
          navImg.style.width = '100%';
          navImg.style.height = '100%';
          navImg.style.objectFit = 'cover';
          // hide the initial text content
          navAvatar.textContent = '';
          navAvatar.appendChild(navImg);
        }
        navImg.src = url;
        navImg.style.display = 'block';
      }
    });

    function openPanel(){
      var src = currentUrl || (preview && preview.src);
      if (!src) return;
      full.src = src;
      panel.classList.add('open');
      panel.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
    }
    function closePanel(){
      panel.classList.remove('open');
      panel.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
    }
    if (clickTarget){
      clickTarget.addEventListener('click', openPanel);
      clickTarget.addEventListener('keydown', function(e){ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openPanel(); }});
    }
    const closeBtn = document.getElementById('avatarPreviewClose');
    if (closeBtn){ closeBtn.addEventListener('click', closePanel); }
    // Close on backdrop click
    if (panel){ panel.addEventListener('click', function(e){ if (e.target === panel) closePanel(); }); }
    // Close on Escape key
    document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && panel.classList.contains('open')) closePanel(); });
  })();
  </script>
{% endblock %}
