{% extends 'base.html' %}
{% load static %}
{% block title %}Profile · AI Japanese Feedback{% endblock %}
{% block content %}
<style>
  /* Inline preview panel within the container */
  .avatar-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 9999; display: none; align-items: center; justify-content: center; padding: 2rem; }
  .avatar-modal.open ~ .container { filter: blur(2px); transform: scale(0.98); transition: all 0.3s ease; }
  .avatar-modal.open { display: flex; }
  .avatar-modal-content { position: relative; max-width: 400px; max-height: 400px; background: var(--bg-primary); border-radius: 16px; overflow: hidden; box-shadow: 0 25px 50px rgba(0,0,0,0.25); }
  .avatar-modal img { display: block; width: 100%; height: auto; max-height: 400px; object-fit: contain; }
  .avatar-modal-close { position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border-radius: 50%; background: rgba(0,0,0,0.6); border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 300; }
  .avatar-modal-close:hover { background: rgba(0,0,0,0.8); }
  .avatar-edit-btn:hover { background: var(--bg-secondary); transform: scale(1.05); transition: all 0.2s ease; }
  [data-theme="dark"] .avatar-edit-btn img { filter: invert(1); }
  .remove-avatar-toggle:hover { background: rgba(0,0,0,0.05); }
  .remove-avatar-toggle input[type="checkbox"] { position: absolute; opacity: 0; pointer-events: none; }
  .remove-avatar-toggle input[type="checkbox"]:checked ~ .custom-checkbox { background: #ef4444; border-color: #ef4444; }
  .remove-avatar-toggle input[type="checkbox"]:checked ~ .custom-checkbox .check-icon { opacity: 1; }
  [data-theme="dark"] .remove-avatar-toggle:hover { background: rgba(255,255,255,0.05); }
</style>

<h1 style="font-size:1.25rem; margin-bottom:1rem;">Profile</h1>

<form method="post" enctype="multipart/form-data" novalidate style="display:grid; gap:1rem; max-width:720px;">
  {% csrf_token %}

  <div style="display:flex; gap:1.25rem; align-items:flex-start;">
    <div style="min-width:120px; text-align:center;">
      <div class="avatar-container" style="position:relative; width:96px; height:96px; margin:0 auto;">
        <div id="avatarClickTarget" style="width:100%;height:100%;border-radius:50%;overflow:hidden;box-shadow:0 4px 12px rgba(0,0,0,.12);background:linear-gradient(135deg, var(--brand), var(--brand-2));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:1.6rem; cursor: pointer;" title="Click to view full size" role="button" tabindex="0">
          {% if profile.avatar %}
            <img id="avatarPreview" src="{{ profile.avatar.url }}" alt="avatar" style="width:100%;height:100%;object-fit:cover;display:block;" />
            <span id="avatarInitial" style="display:none;">{{ user.username|slice:":1"|upper }}</span>
          {% else %}
            <img id="avatarPreview" src="{% static 'core/default-avatar.svg' %}" alt="avatar" style="width:100%;height:100%;object-fit:cover;display:block;" />
            <span id="avatarInitial" style="display:none;">{{ user.username|slice:":1"|upper }}</span>
          {% endif %}
        </div>
        <label for="id_avatar" class="avatar-edit-btn" style="position:absolute; bottom:-2px; right:-2px; width:28px; height:28px; border-radius:50%; background:var(--bg-primary); border:2px solid var(--border-color); display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 2px 8px rgba(0,0,0,.15);" title="Edit profile picture">
          <img src="{% static 'core/edit-icon.svg' %}" alt="Edit" width="14" height="14">
        </label>
      </div>
      {% if profile.avatar and profile.avatar.name %}
      <div style="margin-top:.8rem; text-align:center;">
        <button type="button" id="removeAvatarBtn" class="btn btn-danger" style="font-size:.8rem; padding:.3rem .6rem; height:auto;">Remove Avatar</button>
      </div>
      {% endif %}
    </div>
    <div style="flex:1; display:grid; gap:.75rem;">
      {% if form.non_field_errors %}
        <div style="padding:.6rem .8rem; border-radius:8px; background: rgba(239,68,68,.12); color:#b91c1c; border:1px solid rgba(239,68,68,.25);">{{ form.non_field_errors }}</div>
      {% endif %}

      <div>
        <label style="display:block; font-weight:600; margin-bottom:.25rem;">Username</label>
        {{ form.username }}
        {{ form.username.errors }}
      </div>
      <div style="display:flex; gap:.75rem;">
        <div style="flex:1;">
          <label style="display:block; font-weight:600; margin-bottom:.25rem;">First name</label>
          {{ form.first_name }}
          {{ form.first_name.errors }}
        </div>
        <div style="flex:1;">
          <label style="display:block; font-weight:600; margin-bottom:.25rem;">Last name</label>
          {{ form.last_name }}
          {{ form.last_name.errors }}
        </div>
      </div>
      <div>
        <label style="display:block; font-weight:600; margin-bottom:.25rem;">Email</label>
        {{ form.email }}
        {{ form.email.errors }}
      </div>
    </div>
  </div>

  <input type="file" id="id_avatar" name="avatar" accept="image/*" style="display:none;" />
  {% if avatar_form.non_field_errors %}
    <div style="color:#b91c1c;">{{ avatar_form.non_field_errors }}</div>
  {% endif %}
  {% for f in avatar_form %}
    {% if f.errors %}<div style="color:#b91c1c;">{{ f.errors }}</div>{% endif %}
  {% endfor %}

  <div style="display:flex; gap:.5rem; align-items:center; margin-top:.25rem;">
    <button class="btn btn-primary" type="submit">Save Changes</button>
    <a class="btn btn-secondary" href="{% url 'password_update' %}">Change Password</a>
  </div>
</form>
<div id="avatarModal" class="avatar-modal" aria-hidden="true">
  <div class="avatar-modal-content">
    <button type="button" class="avatar-modal-close" id="avatarPreviewClose">×</button>
    <img id="avatarFull" src="" alt="Profile picture">
  </div>
</div>
<script>
  (function(){
    const fileInput = document.getElementById('id_avatar');
    const preview = document.getElementById('avatarPreview');
    const initial = document.getElementById('avatarInitial');
    const clickTarget = document.getElementById('avatarClickTarget');
    const panel = document.getElementById('avatarModal');
    const full = document.getElementById('avatarFull');
    let currentUrl = preview && preview.src && !preview.src.includes('default-avatar.svg') ? preview.src : '';
    if (!fileInput) return;
    let lastUrl = null;
    fileInput.addEventListener('change', function(){
      const f = this.files && this.files[0];
      if (!f) return;
      if (lastUrl) URL.revokeObjectURL(lastUrl);
      const url = URL.createObjectURL(f);
      lastUrl = url;
      currentUrl = url;
      if (initial) initial.style.display = 'none';
      if (preview){ preview.src = url; preview.style.display = 'block'; }
      // Reset remove checkbox when new file selected
      const removeCheckbox = document.getElementById('id_remove_avatar');
      if (removeCheckbox) removeCheckbox.checked = false;
      // Also update navbar avatar if present
      const navAvatar = document.querySelector('.profile-wrap .avatar');
      if (navAvatar){
        let navImg = navAvatar.querySelector('img');
        if (!navImg){
          navImg = document.createElement('img');
          navImg.alt = 'avatar';
          navImg.style.width = '100%';
          navImg.style.height = '100%';
          navImg.style.objectFit = 'cover';
          // hide the initial text content
          navAvatar.textContent = '';
          navAvatar.appendChild(navImg);
        }
        navImg.src = url;
        navImg.style.display = 'block';
      }
    });

    function openPanel(){
      var src = currentUrl || (preview && preview.src);
      if (!src || src.includes('default-avatar.svg')) return;
      full.src = src;
      panel.classList.add('open');
      panel.setAttribute('aria-hidden', 'false');
      document.body.style.overflow = 'hidden';
      // Add blur effect to container content, not the modal
      const container = document.querySelector('.container');
      if (container) {
        const modal = document.getElementById('avatarModal');
        if (modal) modal.remove();
        document.body.appendChild(modal);
        container.style.cssText = 'filter: blur(2px); transform: scale(0.98); transition: all 0.3s ease;';
      }
    }
    function closePanel(){
      panel.classList.remove('open');
      panel.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      // Remove blur effect
      const container = document.querySelector('.container');
      if (container) container.style.cssText = '';
    }
    if (clickTarget){
      clickTarget.addEventListener('click', openPanel);
      clickTarget.addEventListener('keydown', function(e){ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openPanel(); }});
    }
    const closeBtn = document.getElementById('avatarPreviewClose');
    if (closeBtn){ closeBtn.addEventListener('click', closePanel); }
    // Close on backdrop click
    if (panel){ panel.addEventListener('click', function(e){ if (e.target === panel) closePanel(); }); }
    // Close on Escape key
    document.addEventListener('keydown', function(e){ if (e.key === 'Escape' && panel.classList.contains('open')) closePanel(); });
    
    // Custom confirmation modal
    function showConfirmModal(message, onConfirm) {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center;';
      modal.innerHTML = `
        <div style="background:var(--bg-primary);border-radius:12px;padding:1.5rem;max-width:400px;box-shadow:0 25px 50px rgba(0,0,0,0.25);">
          <h3 style="margin:0 0 1rem 0;color:var(--text-primary);">Confirm Action</h3>
          <p style="margin:0 0 1.5rem 0;color:var(--text-secondary);">${message}</p>
          <div style="display:flex;gap:.5rem;justify-content:flex-end;">
            <button class="cancel-btn" style="padding:.5rem 1rem;border:1px solid var(--border-color);border-radius:8px;background:var(--bg-primary);color:var(--text-primary);cursor:pointer;">Cancel</button>
            <button class="confirm-btn" style="padding:.5rem 1rem;border:none;border-radius:8px;background:#ef4444;color:white;cursor:pointer;">Remove</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      modal.querySelector('.cancel-btn').onclick = () => { document.body.removeChild(modal); };
      modal.querySelector('.confirm-btn').onclick = () => { document.body.removeChild(modal); onConfirm(); };
      modal.onclick = (e) => { if (e.target === modal) document.body.removeChild(modal); };
    }
    
    // Instant avatar removal
    const removeBtn = document.getElementById('removeAvatarBtn');
    if (removeBtn) {
      removeBtn.addEventListener('click', function() {
        showConfirmModal('Remove your avatar? This cannot be undone.', () => {
          // Create temporary form for avatar removal
          const tempForm = document.createElement('form');
          tempForm.method = 'POST';
          tempForm.action = window.location.pathname;
          tempForm.style.display = 'none';
          
          const csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = 'csrfmiddlewaretoken';
          csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
          
          const removeInput = document.createElement('input');
          removeInput.type = 'hidden';
          removeInput.name = 'remove_avatar';
          removeInput.value = 'on';
          
          tempForm.appendChild(csrfInput);
          tempForm.appendChild(removeInput);
          document.body.appendChild(tempForm);
          tempForm.submit();
        });
      });
    }
  })();
  </script>
{% endblock %}
