{% extends 'base.html' %}
{% block title %}Batch Correction{% endblock %}
{% block content %}
<style>
  /* Section layout to match speak-ai */
  .section { margin-bottom: 0.75rem; padding: 0.9rem; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color); transition: all 0.3s ease; }
  .section:hover { transform: translateY(-1px); box-shadow: var(--shadow-sm); }
  .section h3 { color: var(--text-primary); font-size: 1rem; font-weight: 600; margin-bottom: 0.6rem; display: flex; align-items: center; gap: 0.5rem; }
  .section h3::before { content: ''; width: 3px; height: 16px; background: linear-gradient(135deg, var(--brand), var(--brand-2)); border-radius: 2px; }
  .index-page .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.45rem; padding: 0.65rem 1rem; margin: 0.2rem; border: none; border-radius: 8px; font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; text-decoration: none; min-width: 110px; white-space: nowrap; }
  .index-page .btn-primary { background: linear-gradient(135deg, var(--brand), var(--brand-2)); color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
  .index-page .btn-secondary { background: rgba(102, 126, 234, 0.1); color: var(--brand); border: 1px solid rgba(102, 126, 234, 0.2); }
  .dropzone { border: 2px dashed var(--border-color); border-radius: 10px; padding: 1rem; text-align: center; transition: all 0.2s ease; background: var(--bg-secondary); cursor: pointer; }
  #batchDropzone { padding: .6rem .8rem; }
  #batchDropzone .dropzone-content { gap: .35rem; display:flex; flex-direction:column; align-items:center; }
  #batchDropzone .dropzone-icon { font-size: 1.2rem; }
  #batchDropzone .dropzone-text { font-size: .9rem; }
  #batchDropzone .dropzone-subtext { font-size: .75rem; }
  #batchDropzone.has-file { border-color: var(--brand); background: rgba(102,126,234,.08); box-shadow: 0 0 0 3px rgba(102,126,234,.12); }
  #batchDropzone.has-file #batchChosen { color: var(--brand); }
  /* Match speak-ai select sizing */
  .batch-page select { width: 100%; padding: 0.7rem 0.9rem; border: 2px solid var(--border-color); border-radius: 10px; font-size: 0.95rem; transition: all 0.3s ease; background: var(--bg-primary); color: var(--text-primary); }
  .batch-page select:focus { outline: none; border-color: var(--brand); box-shadow: 0 0 0 3px rgba(102,126,234,.15); transform: translateY(-1px); }
  /* Attention animation for Download Result (same as speak-ai) */
  @keyframes pulseNotice { 0%{ transform: scale(1); box-shadow: 0 0 0 0 rgba(102,126,234,.0);} 50%{ transform: scale(1.03); box-shadow: 0 0 0 6px rgba(102,126,234,.12);} 100%{ transform: scale(1); box-shadow: 0 0 0 0 rgba(102,126,234,.0);} }
  #batchDownload.attention { animation: pulseNotice .9s ease-in-out 4; }
  @media (prefers-reduced-motion: reduce) { #batchDownload.attention { animation: none; } }
</style>

<div class="index-page batch-page">
  <h1 style="text-align:center; font-size:1.6rem; font-weight:700; margin-bottom:.5rem;">ðŸ“„ Batch Correction</h1>
  <p class="subtitle" style="text-align:center; margin-bottom:1rem;">Upload CSV/Excel, process Column F, get corrected text and explanations in G/H.</p>

  <div class="section">
    <h3>ðŸ¤– Select AI Model</h3>
    <select id="globalProvider">
      <option value="openai" {% if selected_provider == 'openai' %}selected{% endif %}>OpenAI (GPT-4o-mini)</option>
      <option value="gemini" {% if selected_provider == 'gemini' %}selected{% endif %}>Google Gemini (2.5-flash-lite)</option>
      <option value="bedrock" {% if selected_provider == 'bedrock' %}selected{% endif %}>AWS Bedrock (Nova Lite)</option>
    </select>
  </div>

  <div class="section">
    <form id="batchForm" action="{% url 'batch_create' %}" method="post" enctype="multipart/form-data" class="index-page">
      {% csrf_token %}
      <div id="batchDropzone" class="dropzone" onclick="document.getElementById('batchFile').click()" role="button" tabindex="0" aria-label="Upload CSV or Excel">
        <div class="dropzone-content">
          <div class="dropzone-icon">ðŸ“‘</div>
          <div class="dropzone-text">Upload a CSV or Excel file</div>
          <div class="dropzone-subtext">Takes column F (IncorrectText). Writes corrected_text â†’ G, explanation (JSON) â†’ H.</div>
          <div id="batchChosen" class="dropzone-subtext" style="display:none; font-weight:700;"></div>
        </div>
      </div>
      <input id="batchFile" name="batch_file" type="file" accept=".csv,.xlsx,.xls,text/csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" style="display:none" />
      <div id="batchSelected" style="display:none; margin-top:.5rem; color: var(--text-secondary);">
        Selected: <span id="batchFileName" style="font-weight:700;"></span>
        <button type="button" id="batchFileClear" class="btn btn-secondary" style="height:28px; padding:.2rem .6rem; margin-left:.5rem;">Clear</button>
      </div>
      <input type="hidden" id="batchProvider" name="provider" value="{{ selected_provider|default:'gemini' }}">
      <div class="index-page btn-group" style="justify-content:flex-start; margin-top: .9rem;">
        <button id="batchSubmit" type="submit" class="btn btn-primary">Process File</button>
        <a class="btn btn-secondary" href="{% url 'batch_history' %}">Batch Jobs</a>
      </div>
    </form>
    <div id="batchProgressWrap" style="display:none; margin-top:.75rem;">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:.35rem;">
        <div style="font-weight:700; color: var(--text-secondary);">Processingâ€¦</div>
        <div id="batchPercent" style="color: var(--text-muted);">0%</div>
      </div>
      <div style="width:100%; height: 12px; background: rgba(102,126,234,.12); border-radius: 999px; overflow:hidden; border: 1px solid rgba(102,126,234,.25);">
        <div id="batchProgressBar" style="height:100%; width:0%; background: linear-gradient(135deg, var(--brand), var(--brand-2)); transition: width .3s ease;"></div>
      </div>
      <div id="batchStatusText" style="margin-top:.4rem; color: var(--text-muted); font-size:.9rem;"></div>
      <div class="index-page btn-group" style="justify-content:flex-start; align-items:center; gap:.35rem; margin-top:.5rem;">
        <a id="batchDownload" class="btn btn-secondary" href="#" style="display:none;">Download Result</a>
        <span id="batchNewBadge" class="badge-new" style="display:none;">New</span>
        <button id="batchCancelBtn" type="button" class="btn btn-danger" style="display:none;">Cancel Job</button>
        <a class="btn btn-secondary" href="{% url 'batch_history' %}">View History</a>
      </div>
    </div>
    <div class="dropzone-subtext" style="margin-top:.4rem;">Tip: First row header "IncorrectText" is kept; results go to G/H.</div>
  </div>
</div>

<script>
  (function(){
    const form = document.getElementById('batchForm');
    const fileInput = document.getElementById('batchFile');
    const submitBtn = document.getElementById('batchSubmit');
    const selectedWrap = document.getElementById('batchSelected');
    const fileNameEl = document.getElementById('batchFileName');
    const fileClearBtn = document.getElementById('batchFileClear');
    const dz = document.getElementById('batchDropzone');
    const chosenEl = document.getElementById('batchChosen');
    const wrap = document.getElementById('batchProgressWrap');
    const bar = document.getElementById('batchProgressBar');
    const pct = document.getElementById('batchPercent');
    const statusText = document.getElementById('batchStatusText');
    const dl = document.getElementById('batchDownload');
    const newBadge = document.getElementById('batchNewBadge');
    const cancelBtn = document.getElementById('batchCancelBtn');

    // model selection link
    const globalProvider = document.getElementById('globalProvider');
    const batchProvider = document.getElementById('batchProvider');
    if (globalProvider && batchProvider) {
      batchProvider.value = globalProvider.value;
      globalProvider.addEventListener('change', () => { batchProvider.value = globalProvider.value; });
    }

    // Dropzone events
    dz.addEventListener('dragover', (e)=>{ e.preventDefault(); dz.classList.add('highlight'); });
    dz.addEventListener('dragleave', ()=> dz.classList.remove('highlight'));
    dz.addEventListener('drop', (e)=>{ e.preventDefault(); dz.classList.remove('highlight'); const files = e.dataTransfer.files; if (files.length > 0) { fileInput.files = files; onFileChosen(files[0]); }});
    dz.addEventListener('keydown', (e)=>{ if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); fileInput.click(); }});

    function onFileChosen(file){ selectedWrap.style.display='block'; fileNameEl.textContent = `${file.name} (${(file.size/1024/1024).toFixed(2)} MB)`; chosenEl.style.display='block'; chosenEl.textContent = `Chosen: ${file.name}`; dz.classList.add('has-file'); }
    fileInput.addEventListener('change', ()=>{ const f = fileInput.files[0]; if (f) onFileChosen(f); });
    fileClearBtn.addEventListener('click', ()=>{ fileInput.value=''; selectedWrap.style.display='none'; chosenEl.style.display='none'; dz.classList.remove('has-file'); });

    function updateUI(percent, processed, total, status){
      if (typeof percent === 'number') { bar.style.width = Math.max(0, Math.min(100, percent)) + '%'; pct.textContent = Math.max(0, Math.min(100, percent)) + '%'; }
      if (typeof processed === 'number' && typeof total === 'number') { statusText.textContent = `Processed ${processed} of ${total} rows`; }
      if (status) { statusText.textContent = statusText.textContent ? statusText.textContent + ` â€¢ ${status}` : status; }
    }

    async function poll(jobId){
      try {
        const res = await fetch(`/batch-correction/${jobId}/status`, {credentials: 'same-origin', headers: { 'Accept': 'application/json', 'X-Requested-With': 'XMLHttpRequest' }});
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (!data.ok) throw new Error('Status error');
        updateUI(data.percent, data.processed, data.total, data.status);
        if (data.status === 'done'){
          clearInterval(pollTimer); dl.href = data.download_url; dl.style.display = 'inline-flex';
          // Match speak-ai attention & temporary badge
          dl.classList.add('attention'); setTimeout(()=> dl.classList.remove('attention'), 4000);
          if (newBadge) { newBadge.style.display = 'inline-flex'; setTimeout(()=>{ newBadge.style.display='none'; }, 5000); }
          cancelBtn.style.display='none'; submitBtn.disabled=false; submitBtn.textContent='Process File'; try { localStorage.removeItem('activeBatchJobId'); } catch(e) {}
          if (window.showToast) showToast('Batch complete. Ready to download.', 'success');
        } else if (data.status === 'error'){
          clearInterval(pollTimer); submitBtn.disabled=false; submitBtn.textContent='Process File'; statusText.textContent = `Failed: ${data.error || 'Unknown error'}`; cancelBtn.style.display='none'; try { localStorage.removeItem('activeBatchJobId'); } catch(e) {}
          if (window.showToast) showToast(`Batch failed: ${data.error || 'Unknown'}`, 'error');
        } else if (data.status === 'canceled'){
          clearInterval(pollTimer); submitBtn.disabled=false; submitBtn.textContent='Process File'; statusText.textContent='Canceled by user.'; cancelBtn.style.display='none'; try { localStorage.removeItem('activeBatchJobId'); } catch(e) {}
          if (window.showToast) showToast('Batch canceled.', 'warn');
        } else { cancelBtn.style.display = data.cancelable ? 'inline-flex' : 'none'; }
      } catch (e) { statusText.textContent = `Waiting for statusâ€¦ (${e})`; }
    }

    let pollTimer = null; let currentJobId = null;
    form.addEventListener('submit', async function(e){
      e.preventDefault();
      if (!fileInput.files || !fileInput.files[0]){
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:10000;display:flex;align-items:center;justify-content:center;';
        modal.innerHTML = `
          <div role=\"dialog\" aria-modal=\"true\" style=\"background:var(--bg-primary);border-radius:12px;padding:1.25rem;max-width:420px;box-shadow:0 25px 50px rgba(0,0,0,0.25); border:1px solid var(--border-color);\">\n            <h3 style=\"margin:0 0 .5rem 0;color:var(--text-primary);font-size:1.05rem;\">No file selected</h3>\n            <p style=\"margin:0 0 1rem 0;color:var(--text-secondary);\">Please choose a CSV or Excel file first.</p>\n            <div style=\"display:flex;gap:.5rem;justify-content:flex-end;\">\n              <button class=\"ok-btn\" style=\"padding:.5rem 1rem;border:1px solid var(--border-color);border-radius:8px;background:var(--bg-primary);color:var(--text-primary);cursor:pointer;\">OK</button>\n            </div>\n          </div>`;
        document.body.appendChild(modal);
        const close = ()=>{ try{ document.body.removeChild(modal);}catch(e){} };
        modal.querySelector('.ok-btn').onclick = close; modal.onclick = (ev)=>{ if (ev.target === modal) close(); };
        document.addEventListener('keydown', function esc(ev){ if (ev.key === 'Escape'){ close(); document.removeEventListener('keydown', esc); } });
        return;
      }
      wrap.style.display = 'block'; dl.style.display = 'none'; cancelBtn.style.display = 'none'; updateUI(0,0,0,'Startingâ€¦'); submitBtn.disabled = true; submitBtn.textContent = 'Queuedâ€¦';

      const fd = new FormData(form);
      const res = await fetch(form.action, { method: 'POST', body: fd, headers: { 'X-Requested-With': 'XMLHttpRequest' } });
      if (!res.ok){ submitBtn.disabled=false; submitBtn.textContent='Process File'; statusText.textContent = `Failed to start batch (${res.status})`; return; }
      const data = await res.json();
      if (!data.ok){ submitBtn.disabled=false; submitBtn.textContent='Process File'; statusText.textContent = data.error || 'Failed to start batch'; return; }
      currentJobId = data.job_id; try { localStorage.setItem('activeBatchJobId', String(currentJobId)); } catch(e) {}
      pollTimer = setInterval(()=> poll(currentJobId), 1500);
      cancelBtn.onclick = async () => {
        try { await fetch(`/batch-correction/${currentJobId}/cancel`, { method: 'POST', headers: {'X-CSRFToken': (document.querySelector('[name=csrfmiddlewaretoken]')||{}).value }}); } catch(e){}
        setTimeout(()=> poll(currentJobId), 500);
      };
    });

    // Restore active job if exists
    try{ const active = localStorage.getItem('activeBatchJobId'); if (active){ wrap.style.display='block'; currentJobId = active; pollTimer = setInterval(()=> poll(currentJobId), 1500); } } catch(e){}
  })();
</script>
{% endblock %}
