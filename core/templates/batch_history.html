{% extends 'base.html' %}
{% block title %}Batch History{% endblock %}
{% block content %}
<style>
  .bh-controls { display:flex; gap:.5rem; align-items:end; flex-wrap:wrap; margin-bottom:.75rem; }
  .bh-controls .field { display:flex; flex-direction:column; gap:.25rem; }
  .bh-controls .field label { font-size:.85rem; color: var(--text-secondary); font-weight:600; }
  .bh-controls input, .bh-controls select { padding:.5rem .6rem; border:1px solid var(--border-color); border-radius:8px; background: var(--bg-primary); color: var(--text-primary); }
  .bh-table { width:100%; border-collapse: collapse; font-size: .85rem; }
  /* Draw row separators on the <tr> so empty cells (like Actions) don't break the line */
  .bh-table tr { border-bottom: 1px solid var(--border-color); }
  .bh-table th, .bh-table td { padding:.4rem .5rem; border-bottom: none; }
  .bh-pager { display:flex; gap:.35rem; align-items:center; justify-content:center; margin-top:1rem; flex-wrap:wrap; }
  /* Mobile enhancements */
  @media (max-width: 720px){
    .bh-controls { flex-direction: column; align-items: stretch; }
    .bh-controls .field { width: 100%; }
    .bh-controls .field > div { justify-content: center; }
    .bh-table { border-collapse: separate; border-spacing: 0; font-size: .92rem; }
    .bh-table thead { display: none; }
    .bh-table tr { display: block; border: 1px solid var(--border-color); border-radius: 12px; padding: .6rem .7rem; margin-bottom: .6rem; }
    .bh-table td { display: flex; justify-content: space-between; align-items: baseline; gap:.75rem; padding: .35rem 0; }
    .bh-table td::before { content: attr(data-label); color: var(--text-muted); font-weight: 600; }
    .bh-table td[data-label='File'] { word-break: break-word; }
    .bh-pager { justify-content: center !important; }
  }
</style>

<h1 style="font-size:1.1rem; margin-bottom:.4rem;">Batch Jobs</h1>

<form method="get" class="bh-controls" role="search" aria-label="Filter by date">
  <div class="field">
    <label for="start">From</label>
    <input id="start" type="date" name="start" value="{{ start }}">
  </div>
  <div class="field">
    <label for="end">To</label>
    <input id="end" type="date" name="end" value="{{ end }}">
  </div>
  <div class="field">
    <label for="page_size">Page size</label>
    <select id="page_size" name="page_size" style="padding:.35rem .5rem;">
      <option value="10" {% if page_size == 10 %}selected{% endif %}>10</option>
      <option value="25" {% if page_size == 25 %}selected{% endif %}>25</option>
      <option value="50" {% if page_size == 50 %}selected{% endif %}>50</option>
      <option value="100" {% if page_size == 100 %}selected{% endif %}>100</option>
    </select>
  </div>
  <div class="field" style="gap:.4rem;">
    <label style="visibility:hidden;">Apply</label>
    <div style="display:flex; gap:.5rem;">
      <button class="btn btn-primary" type="submit">Filter</button>
      <a class="btn btn-secondary" href="{% url 'batch_history' %}">Clear</a>
    </div>
  </div>
</form>

<div style="display:flex; gap:.5rem; margin-bottom:.75rem; flex-wrap:wrap; justify-content:flex-end;">
  <a class="btn btn-secondary" href="{% url 'batch_correction' %}">Back to Batch Correction</a>
  <a class="btn btn-secondary" href="{% url 'batch_history' %}">Refresh</a>
</div>

<div style="overflow:auto;">
  <table class="bh-table">
    <thead>
      <tr>
        <th>ID</th>
        <th>File</th>
        <th>Provider</th>
        <th>Status</th>
        <th>Progress</th>
        <th>Created</th>
        <th>Updated</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for j in jobs %}
      <tr>
        <td data-label="ID">{{ j.id }}</td>
        <td data-label="File">{{ j.input_file.name|cut:"batch/" }}</td>
        <td data-label="Provider">{{ j.provider }}</td>
        <td data-label="Status"{% if j.status == 'canceled' %} style="color:#b91c1c; font-weight:700;"{% endif %}>{{ j.status|title }}</td>
        <td data-label="Progress">{{ j.processed_rows }}/{{ j.total_rows }} ({{ j.progress_percent }}%)</td>
        <td data-label="Created">{{ j.created_at|date:"Y-m-d H:i" }}</td>
        <td data-label="Updated">{{ j.updated_at|date:"Y-m-d H:i" }}</td>
        <td data-label="Actions" style="display:flex; gap:.35rem; flex-wrap: wrap;">
          {% if j.status == 'done' and j.output_file %}
            <a class="btn btn-secondary" href="{% url 'batch_download' j.id %}">Download</a>
          {% endif %}
          {% if j.status == 'pending' or j.status == 'running' %}
            <form action="{% url 'batch_cancel' j.id %}" method="post" onsubmit="return confirm('Cancel this job?');">
              {% csrf_token %}
              <button class="btn btn-danger" type="submit">Cancel</button>
            </form>
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="8" style="padding:1rem; color: var(--text-muted);">No jobs yet.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="bh-pager index-page">
  {% if page_obj and page_obj.has_previous %}
    <a class="btn btn-secondary" href="?page={{ page_obj.previous_page_number }}&page_size={{ page_size }}{% if start %}&start={{ start }}{% endif %}{% if end %}&end={{ end }}{% endif %}">Prev</a>
  {% endif %}
  {% if page_obj %}
    <span class="btn btn-secondary" aria-current="page">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
  {% endif %}
  {% if page_obj and page_obj.has_next %}
    <a class="btn btn-secondary" href="?page={{ page_obj.next_page_number }}&page_size={{ page_size }}{% if start %}&start={{ start }}{% endif %}{% if end %}&end={{ end }}{% endif %}">Next</a>
  {% endif %}
</div>


{% endblock %}
