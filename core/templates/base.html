{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}AI Japanese Feedback{% endblock %}</title>
  <link rel="icon" type="image/x-icon" href="{% static 'favicon.ico' %}">
  <link rel="icon" type="image/svg+xml" href="{% static 'favicon.svg' %}">
  <style>
    :root {
      --brand: #667eea;
      --brand-2: #764ba2;
      --bg-primary: #ffffff;
      --bg-secondary: rgba(247, 250, 252, 0.8);
      --text-primary: #2d3748;
      --text-secondary: #4a5568;
      --text-muted: #718096;
      --border-color: #e2e8f0;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 10px 25px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.1);
    }
    html { scrollbar-gutter: stable; }
    [data-theme="dark"] {
      --bg-primary: #1a202c;
      --bg-secondary: rgba(45, 55, 72, 0.8);
      --text-primary: #f7fafc;
      --text-secondary: #e2e8f0;
      --text-muted: #a0aec0;
      --border-color: #4a5568;
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 10px 25px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.5);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; background: linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%); min-height: 100vh; color: var(--text-primary); transition: all 0.3s ease; }
    /* Top nav */
    .topnav { position: fixed; top: 0; left: 0; right: 0; z-index: 1100; background: rgba(255,255,255,.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,.05); box-shadow: 0 2px 10px rgba(0,0,0,.05); }
    [data-theme="dark"] .topnav { background: rgba(26,32,44,.95); border-bottom: 1px solid rgba(255,255,255,.1); box-shadow: 0 2px 10px rgba(0,0,0,.3); }
    .topnav-row { max-width: none; margin: 0; padding: .5rem 1rem; display: flex; align-items: center; gap:.75rem; min-height: 52px; }
    .sidebar.open ~ * .topnav-row { margin-left: 280px; transition: margin-left .2s ease; }
    .brand { font-weight: 800; font-size: 1rem; background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-decoration: none; }
    .nav-actions { margin-left: auto; display:flex; align-items:center; gap:.4rem; }
    .nav-burger, .nav-collapse { background: transparent; border:none; cursor:pointer; padding: 6px; border-radius: 6px; transition: background-color 0.2s ease; }
    .nav-burger:hover, .nav-collapse:hover { background: rgba(0,0,0,0.05); }
    .nav-burger img { display: block; color: var(--text-primary); }
    .nav-collapse { font-size: 16px; color: var(--text-primary); font-weight: 300; display: none; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }
    .sidebar.open + .layout .nav-burger { display: none; }
    .sidebar.open + .layout .nav-collapse { display: inline-flex; }
    [data-theme="dark"] .nav-burger:hover, [data-theme="dark"] .nav-collapse:hover { background: rgba(255,255,255,0.1); }
    [data-theme="dark"] .nav-burger img { filter: invert(1); }
    [data-theme="dark"] .sidebar-header:hover { background: rgba(255,255,255,0.05); }
    [data-theme="dark"] .sidebar-link:hover { background: rgba(255,255,255,0.05); }
    [data-theme="dark"] .sidebar-link.warn:hover { background: rgba(239,68,68,.15); }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:.4rem; padding:.35rem .6rem; border:none; border-radius:8px; font-size:.8rem; font-weight:600; cursor:pointer; text-decoration:none; transition: all .2s ease; height: 32px; white-space: nowrap; }
    .btn-primary { background: linear-gradient(135deg, var(--brand), var(--brand-2)); color:#fff; box-shadow: 0 2px 8px rgba(102,126,234,.3); }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102,126,234,.4); }
    .btn-secondary { background: rgba(102,126,234,.1); color: var(--brand); border: 1px solid rgba(102,126,234,.25); }
    .btn-secondary:hover { background: rgba(102,126,234,.2); }
    .btn-danger { background: rgba(239,68,68,.12); color: #b91c1c; border: 1px solid rgba(239,68,68,.3); }
    .btn-danger:hover { background: rgba(239,68,68,.2); }
    /* Sidebar - GitHub Style Overlay */
    .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background: var(--bg-primary); border-right:1px solid var(--border-color); padding:.75rem; padding-top: 64px; overflow:auto; transform: translateX(-100%); transition: transform .2s ease; z-index: 1050; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
    .sidebar.open { transform: translateX(0); }
    .sidebar-inner { display:flex; flex-direction:column; gap:.75rem; }
    .sidebar-title { font-size:.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing:.06em; font-weight: 600; }
    .sidebar-header { width:100%; display:flex; align-items:center; gap:.5rem; padding:.5rem .75rem; background: transparent; border:none; border-radius:6px; cursor:pointer; color: var(--text-secondary); font-weight:600; text-align:left; font-size: .875rem; transition: background-color 0.15s ease; }
    .sidebar-header:hover { background: rgba(0,0,0,.05); }
    .sidebar-body { display:flex; flex-direction:column; gap:.25rem; padding:.25rem 0 .5rem 0; }
    .sidebar-section.collapsed .sidebar-body { display:none; }
    .sidebar-section .chev { display:inline-block; transition: transform .15s ease; font-size: .75rem; width: 12px; }
    .sidebar-section.collapsed .chev { transform: rotate(-90deg); }
    .sidebar-link { display:flex; align-items:center; gap:.75rem; padding:.5rem .75rem; border-radius:6px; color: var(--text-primary); text-decoration:none; border:none; height: 32px; line-height: 1; font-size: .875rem; font-weight: 500; transition: background-color 0.15s ease; }
    .sidebar-link:hover { background: rgba(0,0,0,.05); }
    .sidebar-link.active { background: rgba(102,126,234,.12); color: var(--brand); font-weight: 600; }
    .sidebar-link .icon { font-size: 1rem; width: 16px; text-align: center; color: var(--text-primary); }
    [data-theme="dark"] .sidebar-link .icon img { filter: invert(1); }
    [data-theme="dark"] .nav-burger img { filter: invert(1); }
    [data-theme="light"] .sidebar-link .icon img { filter: none; }
    [data-theme="light"] .nav-burger img { filter: none; }
    .sidebar-link.warn { color: var(--text-primary); }
    .sidebar-link.warn:hover { color: #dc2626; background: rgba(239,68,68,.08); }
    .sidebar form .sidebar-link { -webkit-appearance: none; appearance: none; background: transparent; border: none; color: var(--text-primary); font: inherit; text-align: left; width: 100%; cursor: pointer; }
    .sidebar-section { display:flex; flex-direction:column; gap:.25rem; }
    .sidebar-section:not(:last-child) { border-bottom: 1px solid var(--border-color); padding-bottom: .75rem; margin-bottom: .75rem; }
    .sidebar-section:not(:last-child):last-of-type { border-bottom: none; }
    /* Layout */
    .layout { display:flex; gap:0; }
    .content-wrap { flex:1; min-width:0; padding: 84px 1rem 1.5rem 1rem; margin-left: 0; transition: margin-left .2s ease; }
    .sidebar.open ~ .layout .content-wrap { margin-left: 280px; }
    .container { max-width: 1000px; margin: 0 auto; padding: 2rem; background: var(--bg-primary); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: var(--shadow-lg); border: 1px solid var(--border-color); transition: all 0.3s ease; }
    /* Profile trigger (compact, like previous) */
    .profile-wrap { position: relative; display:flex; align-items:center; }
    .profile-trigger { display:inline-flex; align-items:center; gap:.35rem; height:32px; padding:.2rem .5rem; border-radius:8px; border:1px solid rgba(102,126,234,.25); background: rgba(102,126,234,.10); cursor:pointer; transition: background .18s ease, box-shadow .18s ease; }
    .profile-trigger:hover { background: rgba(102,126,234,.16); box-shadow: 0 2px 8px rgba(0,0,0,.06); }
    .avatar { width: 24px; height: 24px; border-radius: 50%; display:inline-flex; align-items:center; justify-content:center; font-weight:700; font-size:.8rem; color:#fff; background: linear-gradient(135deg, var(--brand), var(--brand-2)); overflow:hidden; }
    .avatar img { width:100%; height:100%; object-fit: cover; display:block; }
    .username { font-size:.8rem; font-weight:600; color: var(--text-primary); }
    .caret { font-size:.8rem; color: var(--text-muted); transition: transform .18s ease; }
    .profile-wrap:hover .caret { transform: rotate(180deg); }
    .dropdown { position:absolute; top: 100%; right:0; margin-top: 6px; background: var(--bg-primary); border:1px solid var(--border-color); border-radius: 12px; box-shadow: var(--shadow-lg); min-width: 200px; padding:.4rem; z-index: 2000; opacity: 0; transform: translateY(-4px); transition: opacity .18s ease, transform .18s ease; pointer-events: none; }
    .dropdown::before { content: ""; position: absolute; top: -8px; left: 0; right: 0; height: 8px; }
    .dropdown a, .dropdown button { width:100%; text-align:left; padding:.5rem .65rem; border-radius:8px; border:none; background: transparent; color: var(--text-primary); font-size:.9rem; cursor:pointer; display:flex; align-items:center; height:32px; line-height:1; text-decoration:none; }
    .dropdown a:hover, .dropdown button:hover { background: rgba(102,126,234,.10); }
    .profile-wrap:hover .dropdown, .profile-wrap:focus-within .dropdown { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .theme-toggle { background: transparent; border:none; cursor:pointer; padding: 6px; border-radius: 6px; transition: background-color 0.2s ease; }
    .theme-toggle:hover { background: rgba(0,0,0,0.05); }
    .theme-toggle img { display: block; }
    [data-theme="dark"] .theme-toggle:hover { background: rgba(255,255,255,0.1); }
    [data-theme="dark"] .theme-toggle img { filter: invert(1); }
    /* Desktop and Mobile */
    .nav-burger { display: inline-flex; }
    @media (max-width: 900px) {
      .sidebar { padding-top: 64px; }
    }
    /* Toasts */
    .toast-container { position: fixed; right: 16px; bottom: 16px; z-index: 3000; display: flex; flex-direction: column; gap: 8px; }
    .toast { min-width: 220px; max-width: 360px; padding: .7rem .9rem; border-radius: 10px; color: #fff; box-shadow: var(--shadow-md); opacity: 0; transform: translateY(8px); transition: opacity .2s ease, transform .2s ease; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.info { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
    .toast.success { background: linear-gradient(135deg, #10b981, #059669); }
    .toast.error { background: linear-gradient(135deg, #ef4444, #b91c1c); }
    .toast.warn { background: linear-gradient(135deg, #f59e0b, #d97706); }
  </style>
</head>
<body>
  {% include 'partials/navbar.html' %}

  <div class="layout">
    {% include 'partials/sidebar.html' %}
    <div class="content-wrap">

  <main class="container">
    {% if messages %}
      <div class="messages" style="margin-bottom:1rem;">
        {% for message in messages %}
          <div class="message" style="padding:.75rem 1rem; border-radius:10px; background: rgba(72,187,120,.12); color:#2f855a; border-left:4px solid #48bb78; margin-bottom:.5rem;">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}
    {% block content %}{% endblock %}
  </main>

    </div>
  </div>

  <script>
    // Theme toggle like Django admin
    const root = document.documentElement;
    (function(){
      const themeToggle = document.getElementById('themeToggle');
      const themeIcon = document.getElementById('themeIcon');
      const saved = localStorage.getItem('theme') || 'system';
      
      function applyTheme(theme) {
        if (theme === 'system') {
          const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
          root.setAttribute('data-theme', systemDark ? 'dark' : 'light');
        } else {
          root.setAttribute('data-theme', theme);
        }
      }
      
      function updateIcon(theme) {
        const icons = {
          system: '/static/core/auto-icon.svg',
          light: '/static/core/sun-icon.svg',
          dark: '/static/core/moon-icon.svg'
        };
        if (themeIcon) themeIcon.src = icons[theme] || icons.system;
      }
      
      applyTheme(saved);
      updateIcon(saved);
      
      // Listen for system theme changes
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        const currentTheme = localStorage.getItem('theme') || 'system';
        if (currentTheme === 'system') applyTheme('system');
      });
      
      if (themeToggle) {
        themeToggle.addEventListener('click', () => {
          const themes = ['system', 'light', 'dark'];
          const current = localStorage.getItem('theme') || 'system';
          const next = themes[(themes.indexOf(current) + 1) % themes.length];
          
          if (next === 'system') localStorage.removeItem('theme');
          else localStorage.setItem('theme', next);
          
          applyTheme(next);
          updateIcon(next);
        });
      }
    })();

    // Sidebar toggle + persist
    (function(){
      const sidebar = document.getElementById('sidebar');
      const btn = document.getElementById('sidebarToggle');
      const collapseBtn = document.getElementById('sidebarCollapseBtn');
      const key = 'sidebar_open';
      const secKey = (name)=>`sbsec:${name}`;
      function setOpen(open){
        if (!sidebar) return;
        sidebar.classList.toggle('open', open);
        if (btn) btn.setAttribute('aria-expanded', String(open));
        if (collapseBtn) collapseBtn.style.display = open ? 'inline-flex' : 'none';
        btn.style.display = open ? 'none' : 'inline-flex';
        try { localStorage.setItem(key, open ? '1':'0'); } catch(e){}
      }
      if (btn){ btn.addEventListener('click', ()=>{
        const isOpen = sidebar.classList.contains('open');
        setOpen(!isOpen);
      }); }
      if (collapseBtn){ collapseBtn.addEventListener('click', ()=>{
        setOpen(false);
      }); }
      // Start closed by default for overlay
      setOpen(false);
      // Collapsible sections
      document.querySelectorAll('#sidebar .sidebar-section[data-section]').forEach((sec)=>{
        const name = sec.getAttribute('data-section');
        const header = sec.querySelector('.sidebar-header');
        const body = sec.querySelector('.sidebar-body');
        const k = secKey(name);
        let s = '1'; try { s = localStorage.getItem(k) || '1'; } catch(e){}
        const open = s === '1';
        sec.classList.toggle('collapsed', !open);
        if (header){
          header.setAttribute('aria-expanded', String(open));
          header.addEventListener('click', ()=>{
            const nowOpen = sec.classList.toggle('collapsed') ? false : true;
            header.setAttribute('aria-expanded', String(nowOpen));
            try { localStorage.setItem(k, nowOpen ? '1':'0'); } catch(e){}
          });
        }
      });
      // Close drawer when clicking outside on mobile
      document.addEventListener('click', (e)=>{
        if (!sidebar) return; if (!window.matchMedia('(max-width: 900px)').matches) return;
        if (!sidebar.contains(e.target) && e.target !== btn){ sidebar.classList.remove('open'); if (btn) btn.setAttribute('aria-expanded','false'); }
      });
    })();

    // If not authenticated, clear sidebar state and ensure collapsed
    (function(){
      var isAuth = {{ user.is_authenticated|yesno:"true,false" }};
      if (!isAuth){
        try {
          localStorage.removeItem('sidebar_open');
          // clear section states
          Object.keys(localStorage).forEach(function(k){ if (k.startsWith('sbsec:')) localStorage.removeItem(k); });
        } catch(e){}
      }
    })();

    // Simple toast API
    (function(){
      const container = document.createElement('div');
      container.className = 'toast-container';
      document.body.appendChild(container);
      window.showToast = function(msg, type){
        const el = document.createElement('div');
        el.className = 'toast ' + (type || 'info');
        el.textContent = msg;
        container.appendChild(el);
        // Force reflow to trigger animation
        void el.offsetWidth; el.classList.add('show');
        setTimeout(() => { el.classList.remove('show'); setTimeout(() => container.removeChild(el), 200); }, 3500);
      };
    })();
  </script>
</body>
</html>
